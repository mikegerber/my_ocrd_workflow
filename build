#!/bin/sh
DATA_SUBDIR=data

set -e

check_data_subdir() {
  result=0

  if git submodule status $DATA_SUBDIR | grep -q '^-'; then
    echo "$DATA_SUBDIR/ is not an initialized submodule"; result=1
  fi
  if ! [ -e $DATA_SUBDIR/.git/annex ]; then
    echo "$DATA_SUBDIR/ is not a git annex repository"; result=1
  fi
  if ! (cd $DATA_SUBDIR && git annex version | grep -q 'local repository version: 7'); then
    echo "$DATA_SUBDIR/ is not a git annex repository version 7"; result=1
  fi
  if ! (cd $DATA_SUBDIR && git remote | grep -q '^nfs$'); then
    echo "$DATA_SUBDIR/ has no git remote 'nfs'"; result=1
  fi

  return $result
}

download=0
if ! check_data_subdir; then
  select choice in "Abort to manually fix $DATA_SUBDIR submodule" "Download data files from the web"; do
    if [ $REPLY = 1 ]; then
      echo "Suggested commands:"
      echo
      echo "git submodule update --init"
      echo "(cd $DATA_SUBDIR && git annex init --version=7)"
      echo "(cd $DATA_SUBDIR && git remote add nfs /<... path to ...>/GitNX-Repository/qurator/qurator-data)"
      exit
    else
      download=1
    fi
  done
else
  (
    cd data
    for f in "calamari-models/GT4HistOCR/*.ckpt*" "tesseract-models/GT4HistOCR/*.traineddata" "textline_detection/*.h5"; do
      git annex get $f
      git annex fsck $f
    done
  )
fi

docker build -t my_ocrd_workflow .
